name: Retrain ML Model
"on":
  schedule:
    - cron: '0 2 */5 * *'  # Every 5 days at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - name: Validate API_URL secret
        run: |
          if [ -z "${{ secrets.API_URL }}" ]; then
            echo "‚ùå API_URL secret is not set. Go to Settings ‚Üí Secrets ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          echo "‚úÖ API_URL is configured"

      - name: Trigger Model Retraining
        run: |
          echo "üîÑ Calling training endpoint..."
          response=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST \
            "${{ secrets.API_URL }}/api/protection/train-model" \
            -H "Content-Type: application/json" \
            --max-time 30)

          echo "HTTP Status: $response"
          echo "Response body:"
          cat /tmp/response.json

          if [ "$response" -ne 202 ]; then
            echo "‚ùå Training trigger failed with status $response"
            exit 1
          fi

          echo "‚úÖ Model retraining started successfully"